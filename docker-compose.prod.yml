# web(django), nginxのコンテナを作成（本番用）
services:
  # Djangoの設定
  web:
    # コンテナ名をdjangoに設定
    container_name: django
    # Python(django)のDockerfileをビルド
    # ビルドコンテキストは「カレントディレクトリ」とする
    build:
      context: .
      dockerfile: docker/Dockerfile.prod
      # ビルド時のDockerfileの変数設定
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        USERNAME: ${USERNAME:-appuser}
        GROUPNAME: ${GROUPNAME:-appgroup}
    # dockerコンテナ起動時のデフォルトコマンド設定
    command: >
      sh -c "
      python manage.py migrate &&
      python manage.py collectstatic --noinput &&
      gunicorn config.wsgi:application
        --bind 0.0.0.0:8000
        --workers 3
        --max-requests 1000 --max-requests-jitter 100
      "
    # 内部ネットワークの明示（外には公開せず、nginxからのみアクセス可能）
    expose:
      - :"8000"
    # コンテナを削除するまで常に再起動する設定
    restart: always
    # 環境変数の設定
    environment:
      - TZ=${TZ}
    # .envファイルから環境変数を読み込む
    env_file:
      - .env
    # healthcheckの設定
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # nginxの設定
  nginx:
  # コンテナ名をnginxに設定
    container_name: nginx
    image: nginx:1.28
    depends_on:
      - web:
        condition: service_healthy
    ports:
      - "80:80"
    # コンテナを削除するまで常に再起動する設定
    restart: always
    volumes:
      - ./infra/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
